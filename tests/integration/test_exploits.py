"""
Integration tests for all CVE exploit modules against jenkins-lab.

These tests require jenkins-lab Docker container running at localhost:8080.
Run: cd jenkins-lab && docker-compose up -d
"""

from typing import Any

import pytest


@pytest.mark.integration
@pytest.mark.cve
class TestCVEExploits:
    """Test CVE exploit modules against jenkins-lab (Jenkins 2.138.3).

    Note: Not all CVEs will work against this specific Jenkins version.
    See tests/EXPLOIT_COMPATIBILITY.md for details on which exploits work.
    """

    def test_cve_2024_23897_file_read(self, jenkins_session: Any, planted_credentials: dict):
        """Test CVE-2024-23897 CLI arbitrary file read."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2024-23897')
        assert exploit is not None, "CVE-2024-23897 module not found"

        result = exploit.run(
            jenkins_session,
            file_path=planted_credentials["aws"]["location"]
        )

        assert result.status in ["success", "failure"], f"Unexpected error: {result.details}"
        if result.status == "success":
            assert planted_credentials["aws"]["access_key_id"] in str(result.data)


    def test_cve_2019_1003029_groovy_rce(self, jenkins_session: Any):
        """Test CVE-2019-1003029 Groovy RCE - VERIFIED WORKING."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2019-1003029')
        assert exploit is not None, "CVE-2019-1003029 module not found"

        result = exploit.run(
            jenkins_session,
            command='id'
        )

        assert result.status == "success", f"CVE-2019-1003029 should work on jenkins-lab: {result.details}"
        assert result.data is not None


    def test_cve_2024_43044_agent_file_read(self, jenkins_session: Any):
        """Test CVE-2024-43044 agent file read to RCE."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2024-43044')
        assert exploit is not None, "CVE-2024-43044 module not found"

        result = exploit.run(
            jenkins_session,
            mode='file_read',
            file_path='/var/jenkins_home/secrets/master.key'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2018_1000861_stapler_rce(self, jenkins_session: Any):
        """Test CVE-2018-1000861 Stapler RCE."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2018-1000861')
        assert exploit is not None, "CVE-2018-1000861 module not found"

        result = exploit.run(jenkins_session, command='whoami')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2022_43401_pipeline_bypass(self, jenkins_session: Any):
        """Test CVE-2022-43401 Pipeline Groovy sandbox bypass."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2022-43401')
        assert exploit is not None, "CVE-2022-43401 module not found"

        result = exploit.run(
            jenkins_session,
            file_path='/etc/passwd'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2024_34144_sandbox_bypass(self, jenkins_session: Any):
        """Test CVE-2024-34144 Script Security sandbox bypass."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2024-34144')
        assert exploit is not None, "CVE-2024-34144 module not found"

        result = exploit.run(jenkins_session, command='id')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2017_1000353_cli_deserialization(self, jenkins_session: Any):
        """Test CVE-2017-1000353 CLI Java deserialization RCE."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2017-1000353')
        assert exploit is not None, "CVE-2017-1000353 module not found"

        result = exploit.run(
            jenkins_session,
            lhost='127.0.0.1',
            lport=9001
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2019_1003040_constructor_bypass(self, jenkins_session: Any):
        """Test CVE-2019-1003040 constructor-based sandbox bypass."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2019-1003040')
        assert exploit is not None, "CVE-2019-1003040 module not found"

        result = exploit.run(jenkins_session, command='whoami')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2021_21602_workspace_file_read(self, jenkins_session: Any):
        """Test CVE-2021-21602 workspace browser file read."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2021-21602')
        assert exploit is not None, "CVE-2021-21602 module not found"

        result = exploit.run(
            jenkins_session,
            file_path='/etc/passwd'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2022_30945_groovy_injection(self, jenkins_session: Any):
        """Test CVE-2022-30945 Pipeline Groovy OS command injection."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2022-30945')
        assert exploit is not None, "CVE-2022-30945 module not found"

        result = exploit.run(jenkins_session, command='id')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2023_27903_credential_exposure(self, jenkins_session: Any):
        """Test CVE-2023-27903 credential exposure via webhook."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2023-27903')
        assert exploit is not None, "CVE-2023-27903 module not found"

        result = exploit.run(
            jenkins_session,
            repository_url='https://github.com/test/repo.git'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2019_10358_maven_info_disclosure(self, jenkins_session: Any):
        """Test CVE-2019-10358 Maven plugin information disclosure."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2019-10358')
        assert exploit is not None, "CVE-2019-10358 module not found"

        result = exploit.run(jenkins_session)

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2018_1000402_aws_env_exposure(self, jenkins_session: Any):
        """Test CVE-2018-1000402 AWS CodeDeploy environment variable exposure."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2018-1000402')
        assert exploit is not None, "CVE-2018-1000402 module not found"

        result = exploit.run(jenkins_session)

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2020_2249_credential_exposure(self, jenkins_session: Any):
        """Test CVE-2020-2249 TFS plugin credential exposure."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2020-2249')
        assert exploit is not None, "CVE-2020-2249 module not found"

        result = exploit.run(jenkins_session)

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2021_21686_path_traversal(self, jenkins_session: Any):
        """Test CVE-2021-21686 agent-to-controller path traversal."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2021-21686')
        assert exploit is not None, "CVE-2021-21686 module not found"

        result = exploit.run(
            jenkins_session,
            file_path='/etc/passwd'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2022_34177_input_step_traversal(self, jenkins_session: Any):
        """Test CVE-2022-34177 Pipeline Input Step path traversal."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2022-34177')
        assert exploit is not None, "CVE-2022-34177 module not found"

        result = exploit.run(
            jenkins_session,
            target_path='../../../../tmp/test.txt',
            content='test'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2016_0792_xstream_deserialize(self, jenkins_session: Any):
        """Test CVE-2016-0792 XStream deserialization RCE."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2016-0792')
        assert exploit is not None, "CVE-2016-0792 module not found"

        result = exploit.run(jenkins_session, command='id')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2019_1003000_ast_bypass(self, jenkins_session: Any):
        """Test CVE-2019-1003000 Script Security AST transformation bypass."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2019-1003000')
        assert exploit is not None, "CVE-2019-1003000 module not found"

        result = exploit.run(jenkins_session, command='whoami')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2019_1003001_pipeline_bypass(self, jenkins_session: Any):
        """Test CVE-2019-1003001 Pipeline Groovy plugin sandbox bypass."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2019-1003001')
        assert exploit is not None, "CVE-2019-1003001 module not found"

        result = exploit.run(jenkins_session, command='id')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2018_1000600_github_file_read(self, jenkins_session: Any):
        """Test CVE-2018-1000600 GitHub plugin arbitrary file read."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2018-1000600')
        assert exploit is not None, "CVE-2018-1000600 module not found"

        result = exploit.run(
            jenkins_session,
            file_path='/etc/passwd'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2020_2100_udp_amplification(self, jenkins_session: Any):
        """Test CVE-2020-2100 UDP amplification reflection attack."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2020-2100')
        assert exploit is not None, "CVE-2020-2100 module not found"

        result = exploit.run(jenkins_session)

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2023_24422_sandbox_bypass(self, jenkins_session: Any):
        """Test CVE-2023-24422 Script Security plugin sandbox bypass."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2023-24422')
        assert exploit is not None, "CVE-2023-24422 module not found"

        result = exploit.run(jenkins_session, command='whoami')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2024_47803_secret_exposure(self, jenkins_session: Any):
        """Test CVE-2024-47803 multi-line secret exposure."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2024-47803')
        assert exploit is not None, "CVE-2024-47803 module not found"

        result = exploit.run(jenkins_session)

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2025_31722_templating_rce(self, jenkins_session: Any):
        """Test CVE-2025-31722 Templating Engine plugin RCE."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2025-31722')
        assert exploit is not None, "CVE-2025-31722 module not found"

        result = exploit.run(jenkins_session, command='id')

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_cve_2023_3519_citrix_rce(self, jenkins_session: Any):
        """Test CVE-2023-3519 Citrix NetScaler RCE."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('CVE-2023-3519')
        assert exploit is not None, "CVE-2023-3519 module not found"

        result = exploit.run(jenkins_session)

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_feature_script_console_blind_rce(self, jenkins_session: Any):
        """Test FEATURE-SCRIPT-CONSOLE blind RCE detection."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('FEATURE-SCRIPT-CONSOLE')
        assert exploit is not None, "FEATURE-SCRIPT-CONSOLE module not found"

        result = exploit.run(
            jenkins_session,
            command='whoami',
            detection_method='sleep'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


    def test_feature_job_config_injection(self, jenkins_session: Any, cleanup_test_job):
        """Test FEATURE-JOB-CONFIG job configuration injection."""
        from jenkins_breaker.modules import exploit_registry

        exploit = exploit_registry.get('FEATURE-JOB-CONFIG')
        assert exploit is not None, "FEATURE-JOB-CONFIG module not found"

        test_job = "test-injected-job"
        cleanup_test_job(test_job)

        result = exploit.run(
            jenkins_session,
            job_name=test_job,
            malicious_code='echo "test"'
        )

        assert result.status in ["success", "error"], f"Exploit result: {result.details}"


@pytest.mark.integration
@pytest.mark.cve
class TestExploitRegistry:
    """Test exploit registry functionality."""

    def test_exploit_registry_has_all_cves(self, exploit_registry):
        """Verify all CVE modules are registered."""
        expected_cves = [
            'CVE-2016-0792', 'CVE-2017-1000353', 'CVE-2018-1000402',
            'CVE-2018-1000600', 'CVE-2018-1000861', 'CVE-2019-1003000',
            'CVE-2019-1003001', 'CVE-2019-1003029', 'CVE-2019-1003040',
            'CVE-2019-10358', 'CVE-2020-2100', 'CVE-2020-2249',
            'CVE-2021-21602', 'CVE-2021-21686', 'CVE-2022-30945',
            'CVE-2022-34177', 'CVE-2022-43401', 'CVE-2023-24422',
            'CVE-2023-27903', 'CVE-2023-3519', 'CVE-2024-23897',
            'CVE-2024-34144', 'CVE-2024-43044', 'CVE-2024-47803',
            'CVE-2025-31722', 'FEATURE-SCRIPT-CONSOLE', 'FEATURE-JOB-CONFIG'
        ]

        registered_cves = exploit_registry.list_cves()

        for cve in expected_cves:
            assert cve in registered_cves, f"{cve} not registered in exploit_registry"


    def test_exploit_registry_metadata(self, exploit_registry):
        """Verify all registered exploits have valid metadata."""
        for cve_id in exploit_registry.list_cves():
            exploit = exploit_registry.get(cve_id)

            assert exploit is not None, f"Exploit {cve_id} is None"
            assert hasattr(exploit, 'METADATA'), f"{cve_id} missing METADATA"

            metadata = exploit.METADATA
            assert metadata.cve_id == cve_id, f"{cve_id} metadata mismatch"
            assert metadata.name, f"{cve_id} missing name"
            assert metadata.severity in ["critical", "high", "medium", "low"], f"{cve_id} invalid severity"
            assert len(metadata.mitre_attack) > 0, f"{cve_id} missing MITRE ATT&CK mapping"
