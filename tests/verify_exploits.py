"""
Verify that exploits actually work against jenkins-lab.
"""

import sys

sys.path.insert(0, r'C:\Users\Chogyam\.zenflow\worktrees\breakapart-db88\JenkinsBreaker\src')

from jenkins_breaker.core.session import JenkinsSession, SessionConfig
from jenkins_breaker.modules import exploit_registry


def test_script_console():
    """Test FEATURE-SCRIPT-CONSOLE exploit."""
    print("[*] Testing FEATURE-SCRIPT-CONSOLE...")

    config = SessionConfig(
        url="http://localhost:8080",
        username="admin",
        password="admin",
        verify_ssl=False
    )

    session = JenkinsSession(config)

    exploit = exploit_registry.get('FEATURE-SCRIPT-CONSOLE')
    if not exploit:
        print("[!] FEATURE-SCRIPT-CONSOLE module not found")
        return False

    result = exploit.run(session, command='id')

    print(f"[*] Status: {result.status}")
    print(f"[*] Details: {result.details}")
    if result.data:
        print(f"[*] Output: {result.data.get('output', 'N/A')}")

    return result.status == "success"


def test_cve_2018_1000861():
    """Test CVE-2018-1000861 (Stapler RCE) - Jenkins 2.138.3 is vulnerable."""
    print("\n[*] Testing CVE-2018-1000861 (Stapler RCE)...")

    config = SessionConfig(
        url="http://localhost:8080",
        username="admin",
        password="admin",
        verify_ssl=False
    )

    session = JenkinsSession(config)

    exploit = exploit_registry.get('CVE-2018-1000861')
    if not exploit:
        print("[!] CVE-2018-1000861 module not found")
        return False

    result = exploit.run(session, cmd='id')

    print(f"[*] Status: {result.status}")
    print(f"[*] Details: {result.details}")
    if result.data:
        print(f"[*] Data: {result.data}")

    return result.status == "success"


def test_cve_2019_1003029():
    """Test CVE-2019-1003029 (Pipeline Groovy RCE) - should work with workflow-cps plugin."""
    print("\n[*] Testing CVE-2019-1003029 (Pipeline Groovy RCE)...")

    config = SessionConfig(
        url="http://localhost:8080",
        username="admin",
        password="admin",
        verify_ssl=False
    )

    session = JenkinsSession(config)

    exploit = exploit_registry.get('CVE-2019-1003029')
    if not exploit:
        print("[!] CVE-2019-1003029 module not found")
        return False

    result = exploit.run(session, command='id')

    print(f"[*] Status: {result.status}")
    print(f"[*] Details: {result.details}")
    if result.data:
        print(f"[*] Output preview: {str(result.data)[:200]}")

    return result.status in ["success", "partial"]


def test_cve_2018_1000402():
    """Test CVE-2018-1000402 (AWS CodeDeploy Plugin Credential Exposure)."""
    print("\n[*] Testing CVE-2018-1000402 (AWS CodeDeploy Plugin)...")

    config = SessionConfig(
        url="http://localhost:8080",
        username="admin",
        password="admin",
        verify_ssl=False
    )

    session = JenkinsSession(config)

    exploit = exploit_registry.get('CVE-2018-1000402')
    if not exploit:
        print("[!] CVE-2018-1000402 module not found")
        return False

    result = exploit.run(session)

    print(f"[*] Status: {result.status}")
    print(f"[*] Details: {result.details}")
    if result.data:
        print(f"[*] Data: {result.data}")

    return result.status == "success"


def test_feature_job_config():
    """Test FEATURE-JOB-CONFIG exploit."""
    print("\n[*] Testing FEATURE-JOB-CONFIG...")

    config = SessionConfig(
        url="http://localhost:8080",
        username="admin",
        password="admin",
        verify_ssl=False
    )

    session = JenkinsSession(config)

    exploit = exploit_registry.get('FEATURE-JOB-CONFIG')
    if not exploit:
        print("[!] FEATURE-JOB-CONFIG module not found")
        return False

    result = exploit.run(session, job_name='test-rce-job', command='whoami')

    print(f"[*] Status: {result.status}")
    print(f"[*] Details: {result.details}")

    return result.status == "success"


def main():
    print("=" * 60)
    print("JenkinsBreaker Exploit Verification")
    print("=" * 60)

    results = []

    script_console_success = test_script_console()
    results.append(("FEATURE-SCRIPT-CONSOLE", script_console_success))

    job_config_success = test_feature_job_config()
    results.append(("FEATURE-JOB-CONFIG", job_config_success))

    cve_2019_1003029_success = test_cve_2019_1003029()
    results.append(("CVE-2019-1003029", cve_2019_1003029_success))

    cve_2018_1000402_success = test_cve_2018_1000402()
    results.append(("CVE-2018-1000402", cve_2018_1000402_success))

    print("\n" + "=" * 60)
    print("Results Summary")
    print("=" * 60)

    for name, success in results:
        status = "[+] PASS" if success else "[!] FAIL"
        print(f"{status} {name}")

    total_success = sum(1 for _, success in results if success)
    print(f"\n{total_success}/{len(results)} exploits working")

    return total_success > 0


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
